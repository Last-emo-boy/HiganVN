# 新手脚本编写与素材指南（HiganVN）

这是一份面向零基础的 Galgame 制作入门指南。你将学会：
- 用极简脚本（.vns）写出对话、选项和分支
- 合理组织素材（背景/立绘/音乐/音效/CG/字体）
- 在本地运行并打包成 Windows 可执行文件

建议搭配仓库内 `scripts/demo.vns` 一起对照学习。

---

## 一、环境准备与第一次运行（3 分钟）

1) 准备 Python（3.9+ 推荐 3.11/3.12）：
   - Windows 用户到 python.org 安装，安装时勾选“Add Python to PATH”。
2) 克隆/下载本仓库，打开到仓库根目录。
3) 首次运行（GUI，素材相对 `--assets` 目录）：
   ```powershell
   python -m higanvn run scripts/demo.vns --assets assets --pygame
   ```
   - 如需指定字体：
     ```powershell
     python -m higanvn run scripts/demo.vns --assets assets --pygame --font assets/fonts/思源黑体.ttf --font-size 28
     ```
   - 终端模式（无界面，调试用）：
     ```powershell
     python -m higanvn run scripts/demo.vns
     ```

提示：首次运行如出现音频驱动报错，通常不影响图像显示；若无声，请换用 OGG/WAV 或确认声卡被占用。

---

## 二、快速上手（5 行脚本）

```
> BG bg/教室.png
♪ bgm/校园白日.mp3 0.8

张鹏 「今天放学后一起去天台吗？」
? 去天台 -> roof

*roof
  ♪ None
```

---

## 三、脚本语法详解（从 0 到 1）

- 文件编码：UTF-8
- 每行一条语句；空行与行首/行尾空格会被忽略
- 注释：`#` 开头的内容整行忽略（引号内除外）
- 解析优先级：命令 `>` > 标签 `*`/选项 `?` > 对话 > 旁白

### 3.1 命令 `>`（大小写不敏感）

- 背景：
  - `> BG <路径|None>` 切换背景，`None` 为清空背景
  - 示例：`> BG bg/教室.png`
- 背景音乐：
  - `> BGM <路径|None> [音量]`，音量范围 0–1
  - 示例：`> BGM bgm/白噪音.ogg 0.5`，`♪ bgm/主题曲.mp3 0.8`（`♪` 等同 BGM）
- 音效：
  - `> SE <路径> [音量]`
  - 示例：`> SE se/开门.wav 0.9`
- 配音（Voice，台词语音，可选）：
  - `> VOICE <路径|None> [音量]`
  - 行为：在“下一句对话显示时”播放该音频；推进到下一句会自动停止当前语音；写 `None` 立即停止待播/当前语音。
  - 示例：`> VOICE voice/示例_一句话.ogg 0.9`，`> VOICE None`
- 标题主菜单（Title Screen）：
  - `> TITLE ["标题"] [背景图路径]`
  - 行为：显示一个带“开始游戏 / 读取进度 / 设置 / CG 画廊 / 退出”的主菜单；选择“开始游戏”后脚本继续向下执行。
  - 示例：`> TITLE "SEU Monogatari" bg/title.jpg`
- 整屏 CG：
  - `> CG <路径|None>` 显示/隐藏整屏 CG
  - 可配合 `> FADE` 过渡；显示成功会自动记录为“已解锁”，可在 CG 画廊查看。
- 暗场淡入/淡出：
  - `> FADE in|out [时长ms]`
  - 示例：`> FADE out 400` → `> BG bg/夜晚屋顶.jpg` → `> FADE in 400`
- 角色轻量动画：
  - `> EF <种类> [角色] [时长ms] [幅度px]`
  - 种类：`shake_x`、`shake_y`、`slide_in_l|r|u|d`、`slide_out_l|r|u|d`
  - 示例：`> EF shake_x 张鹏 400 8`、`> EF slide_in_l 张鹏 300`
- 动作叠加（Action，介于整身与表情之间的一层遮罩）：
  - `> ACTION <角色显示名> <name|None>`，如：`> ACTION 张鹏 指` → 期望加载 `ch/zhangpeng/action_指.png`
  - 与服装搭配：如当前服装为 `outfit_xxx`，优先尝试 `ch/zhangpeng/outfit_xxx/action_指.png`
  - `None` 清除当前动作层
- 服装切换（Outfit）：
  - `> OUTFIT <角色显示名> <folder|None>`，例：`> OUTFIT 张鹏 outfit_school_summer`
  - 切换后该角色的 `base`/`pose_*` 优先从子目录加载；`None` 恢复默认
- 调用与返回（子流程）：
  - `> CALL <标签>` 跳转到子流程（压栈返回地址）；`> RETURN` 返回到 `CALL` 的下一条
- 等待（过场停顿）：
  - `> WAIT <毫秒数>` 在脚本层等待指定时长
- 自动模式切换：
  - `> AUTO on|off|toggle` 控制是否自动前进；打开 Backlog 时自动暂停
- 内嵌脚本（安全子集）：
  - `> SCRIPT <单行...>` 或多行块：`> SCRIPT` + 缩进行体
  - 作用域为变量字典 `vars`；详见根目录《SCRIPTING_MANUAL.md》

说明：大多数参数可留空使用默认值；当需要更明确的表现，请显式写出时长/幅度/音量。

### 3.2 标签与选项

- 定义标签：`*label_name`
- 选项行：`? 选项文案 -> 目标标签`
- 连续的多行 `?` 会自动组成一个选择菜单（直到出现非 `?` 行）

### 3.2.1 变量与条件跳转（SET / IF / GOTO / SWITCH）

- 赋值：`> SET 名称 = 表达式`
- 条件跳转：`> IF 表达式 -> 标签`（命中则跳转）
- 语法糖：`ELSEIF` / `ELSE` 配合 `IF` 使用
- 开关分支：`> SWITCH expr` + 多个 `> CASE value -> 标签` + 可选 `> DEFAULT -> 标签` + `> ENDSWITCH`
- 直接跳转：`> GOTO 标签`

变量在快速/槽位存档中会保存，并在回放时恢复，保证可重现。

### 3.3 对话与旁白

- 对话：
  - 引号式：`张鹏 「……」` 或 `张鹏 “……”`
  - 冒号式：`张鹏: ……`
- 修饰（可选，顺序不严格）：
  - 别名：`角色|显示名`（例：`张鹏|学长`）
  - 表情：`(happy)` 对应立绘 `pose_happy.png`
  - 效果标签：`[惊]`、`[笑]` 等作为文本提示，并可能触发动画
- 旁白：无主语文本即为旁白；也可用 `:文本` 强制旁白

---

## 四、素材组织与命名空间（强烈推荐）

引擎会基于“脚本文件名”优先在对应命名空间查找素材：
- 若脚本为 `scripts/demo.vns` → 优先 `assets/demo/`，找不到再回退到 `assets/` 根目录同结构。

推荐目录结构：

```
assets/
  demo/                        # 对应 demo.vns 的命名空间
    bg/                        # 背景图
    cg/                        # 全屏 CG
    bgm/                       # 背景音乐
    se/                        # 音效
    ch/                        # 立绘（每个角色一个文件夹）
    fonts/                     # 可选字体
    config/
      actors_map.json          # 角色显示名 → 文件夹名 映射

  bg/  cg/  bgm/  se/  ch/  fonts/  config/   # 根级回退目录（可选）
```

查找顺序：
1) `assets/<脚本名>/<原始路径>`
2) `assets/<脚本名>/<类型子目录>/<原始路径>`（类型含 bg/cg/bgm/se/ch）
3) `assets/<类型子目录>/<原始路径>`
4) 原始路径（不建议）

---

## 五、角色映射 actors_map.json（必看）

位置优先级：
- `assets/<脚本名>/config/actors_map.json`（优先）
- 回退：`assets/config/actors_map.json`

示例：

```json
{ "张鹏": "zhangpeng", "小马": "xiaoma" }
```

作用：脚本显示名 → 立绘目录名。这样 `张鹏 (happy)` 会加载：
- `assets/.../ch/zhangpeng/base.png`
- `assets/.../ch/zhangpeng/pose_happy.png`

---

## 六、字体与中文显示

- 推荐把字体放进：`assets/<脚本名>/fonts/` 或 `assets/fonts/`
- 运行时指定：
  ```powershell
  --font assets/fonts/思源黑体.ttf --font-size 28
  ```
- 若不指定，渲染器会尝试在命名空间字体目录中寻找合适字体；若中文缺字，请显式指定。

---

## 七、常用脚本套路（可直接套用）

1) 场景切换 + BGM 渐变：

```
> FADE out 400
> BGM None
> BG bg/夜晚屋顶.jpg
> FADE in 400
♪ bgm/星空.ogg 0.6
```

2) 角色入场/强调：

```
> EF slide_in_l 张鹏 300
张鹏 (happy)「我来了！」
> EF shake_x 张鹏 300 10
```

3) 事件 CG：

```
> CG cg/拥抱.png
:时间像停住了一样。
> CG None
```

4) 多分支菜单：

```
:去哪里？
? 天台 -> roof
? 食堂 -> cafe
? 自习室 -> study

*roof
  :风很大。

*cafe
  :咖啡很香。

*study
  :要认真哦。
```

5) 子流程调用/返回：

```
# 公共演出片段
*common_intro
  > FADE out 300
  > BG bg/夜晚屋顶.jpg
  > FADE in 300
  > RETURN

:要不要去屋顶？
? 去 -> roof
? 不去 -> stay

*roof
  > CALL common_intro
  张鹏 (happy)「风有点大！」
  :……

*stay
  :那就各自回家吧。
```

6) 过场等待与自动切换：

```
> AUTO off           # 禁止自动，保证演出不被跳过
> CG cg/夜景.png
> WAIT 800           # 停顿 0.8 秒
> FADE out 300
> CG None
> FADE in 300
> AUTO on            # 恢复自动模式
```

---

## 八、运行与打包（详解）

- 运行（无界面，调试）：
  ```powershell
  python -m higanvn run scripts/demo.vns
  ```
- 运行（GUI）：
  ```powershell
  python -m higanvn run scripts/demo.vns --assets assets --pygame [--font <path>] [--font-size <px>]
  ```
- 打包为 EXE：
  ```powershell
  # 首次需要安装打包工具
  pip install pyinstaller
  # 打包（将记录脚本与打入素材）
  python -m higanvn pack scripts/demo.vns --assets assets --name SEU-Monogatari --output dist --onefile
  ```

产物说明：
- 生成 `dist/SEU-Monogatari.exe`（或同名目录/若非 onefile）。
- 含脚本定位信息与素材；建议仅放入需要的素材以控制体积。
- 某些杀毒软件可能误报，建议压缩为 zip 分发，并附带校验和/来源说明。

---

## 九、从零新建你的剧本（标准流程）

1) 新建脚本：在 `scripts/` 下创建 `my_story.vns`
2) 复制命名空间模板：
   - 复制 `assets/demo/` 为 `assets/my_story/`
   - 清空模板里的占位文件，保留目录结构
3) 配置角色映射：编辑 `assets/my_story/config/actors_map.json`
4) 放入素材：
   - 背景到 `assets/my_story/bg`，立绘到 `assets/my_story/ch/<角色目录>/`
   - 音乐到 `assets/my_story/bgm`，音效到 `assets/my_story/se`
   - 可选字体到 `assets/my_story/fonts`
5) 运行：
   ```powershell
   python -m higanvn run scripts/my_story.vns --assets assets --pygame --font assets/my_story/fonts/xxx.ttf --font-size 28
   ```
6) 打包：
   ```powershell
   python -m higanvn pack scripts/my_story.vns --assets assets --name MyStory --output dist --onefile
   ```

---

## 十、素材规格与最佳实践（建议）

### 10.1 背景与 CG 尺寸

- 画布：引擎以 1280×720（16:9）为基准渲染。
- 推荐：
  - 背景（BG）：1280×720 或 1920×1080（会等比缩放填充，过小会上采样发糊）。
  - CG：与画布一致（1280×720/1920×1080）。
- 提示：
  - 尽量使用与画布同宽高比资源，避免黑边或裁切。
  - 大图会增加显存与加载时间；如需 4K，请谨慎评估内存占用。

### 10.2 立绘规范与表情切换

- 文件格式：PNG（带透明通道）
- 目录结构：`assets/<脚本名>/ch/<角色目录>/`
  - 必备：`base.png`
  - 可选：`pose_<emotion>.png`（如 `pose_happy.png`、`pose_angry.png`）
- 尺寸建议：
  - 半身像高 900–1100 px；全身像高 1200–1600 px
  - 所有立绘保持相同画布尺寸与“脚底线”对齐，避免切换抖动
- 站位建议：边缘留 40–80 px 透明缓冲，利于 slide_in_* 动画
- 表情切换（脚本写法）：`角色 (emotion)「台词」` → 对应 `pose_emotion.png`

#### 10.2.1 多服装（Outfit）

同一角色多套衣装放在子目录：`outfit_xxx/`，文件名与根目录一致。脚本用 `> OUTFIT 角色 outfit_xxx` 切换。

#### 10.2.2 动作（Action）遮罩

在 `ch/<actor>/action_指.png`（或 `.../outfit_xxx/action_指.png`）叠加到 base/pose 上；脚本用 `> ACTION 角色 指` 设置、`None` 清除。

### 10.3 命名与目录约定

- 角色目录名：英文小写、下划线；通过 actors_map.json 映射中文显示名
- 表情命名：`pose_<emotion>.png`
- 资源命名：英文小写 + 下划线；扩展名小写

### 10.4 音频与性能体积

- BGM：OGG/MP3；SE：WAV/OGG；并发尽量少
- 控制单图大小（建议 < 2–4 MB）；按需打包素材

---

## 十一、功能补充：标题菜单、画廊、热键与 UI 设定

### 标题菜单（`> TITLE`）
- 提供：开始游戏 / 读取进度 / 设置 / CG 画廊 / 退出
- 选择“开始游戏”后返回脚本继续执行

### 画廊（Gallery）
- CG 页：网格缩略图，未解锁显示“未解锁”遮罩；回车预览，鼠标可点击
- 分组：按 CG 子目录分组；Q/E 快速切换分组
- BGM 页：列表试听，回车播放/停止，+/- 调音量
- TAB 切换 CG/BGM

### 热键（pygame 版本）
- H：隐藏/显示 UI（对话框/HUD/提示/横幅）
- F12：截图（保存到 `save/screenshots/shot_YYYYMMDD_HHMMSS.png`）
- Tab：打开/关闭回放栏（Backlog）
- F5/F9：快速保存/读取
- F7/F8：打开存/读档槽位

### UI 设定与持久化
- 设置菜单可调整：文本框透明度、文本描边/阴影、自动/打字速度等
- 配置保存在存档目录的 `config.json`，下次启动会自动应用

---

## 十二、完整示例（含标题与菜单说明）

```
> TITLE "SEU Monogatari" bg/title.jpg
> BG bg/教室.jpg
♪ bgm/开场.ogg 0.5
张鹏: 开始新的一天。
```

菜单说明：
- 开始游戏：返回脚本，继续执行下一行
- 读取进度：打开读档界面（F8 也可打开）
- 设置：在 pygame 版本中提供 UI 设定（文本框透明度/描边/阴影、自动/文字速度等，会保存到存档目录）
- CG 画廊：查看已解锁的 CG（支持预览，TAB 切换到 BGM 页面试听，Q/E 切换 CG 分组；+/- 调整 BGM 音量）
- 退出：退出游戏

---

## 速查：非正式语法参考

```
command  := '>' NAME [args...] | '♪' path [volume]
label    := '*' IDENT
choice   := '?' text '->' target
dialogue := [name['|'alias]] [ '('emotion')' ] [ '['effect']' ] ( '「'text'」' | '“'text'”' | ':' text )
narr     := text
```

祝你做出属于自己的 Galgame！

— HiganVN
